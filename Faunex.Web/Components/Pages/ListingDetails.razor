@page "/listings/{ListingId:guid}"

@using Microsoft.AspNetCore.Components.Authorization

@inject Faunex.Web.Api.FaunexApiClient Api
@inject NavigationManager Nav

<h3>Listing Details</h3>

@if (_isLoading)
{
    <p>Loading...</p>
}
else if (_error is not null)
{
    <p>@_error</p>
}
else if (_item is null)
{
    <p>Listing not found or no longer available</p>
}
else
{
    <div class="mb-3">
        <h4>@_item.Title</h4>
        <p class="text-muted mb-1"><strong>Status:</strong> Approved</p>
        <p class="text-muted mb-1"><strong>Listing type:</strong> @GetSaleType(_item)</p>
        <p class="mb-1"><strong>Price:</strong> @GetPriceLabel(_item)</p>

        @if (!string.IsNullOrWhiteSpace(_item.Description))
        {
            <div class="mt-3">
                <strong>Description</strong>
                <p>@_item.Description</p>
            </div>
        }
    </div>

    @if (IsAuction(_item))
    {
        <div class="mb-3">
            <a class="btn btn-outline-primary" href="/auctions/@_item.Id">View Auction</a>
        </div>
    }

    <AuthorizeView>
        <NotAuthorized>
            <div class="alert alert-info">
                <div>Login to bid or buy</div>
                <a class="btn btn-primary mt-2" href="/login">Login</a>
            </div>
        </NotAuthorized>
        <Authorized>
            @if (_isBuyer)
            {
                <div class="alert alert-success">
                    Buyer access confirmed. Go to the auction page to place bids.
                </div>
            }
            else
            {
                <div class="alert alert-secondary">
                    You're signed in, but bidding is only available for Buyer accounts.
                </div>
            }
        </Authorized>
    </AuthorizeView>
}

@code {
    [Parameter] public Guid ListingId { get; set; }

    private bool _isLoading;
    private string? _error;
    private Faunex.Application.DTOs.ListingDto? _item;

    private bool _isBuyer;

    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _error = null;
        _item = null;
        _isBuyer = false;

        try
        {
            var items = await Api.GetAsync<IReadOnlyList<Faunex.Application.DTOs.ListingDto>>("/api/browse/listings");
            _item = items?.FirstOrDefault(x => x.Id == ListingId);

            var authState = AuthenticationStateTask is null ? null : await AuthenticationStateTask;
            var user = authState?.User;

            _isBuyer = user?.Identity?.IsAuthenticated == true && (user.IsInRole("Buyer") || user.Claims.Any(c => c.Type == "role" && c.Value == "Buyer"));
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static bool IsAuction(Faunex.Application.DTOs.ListingDto item)
        => !item.BuyNowPrice.HasValue;

    private static string GetSaleType(Faunex.Application.DTOs.ListingDto item)
        => item.BuyNowPrice.HasValue ? "Fixed Price" : "Auction";

    private static string GetPriceLabel(Faunex.Application.DTOs.ListingDto item)
    {
        if (item.BuyNowPrice.HasValue)
            return $"Buy Now: R{item.BuyNowPrice.Value:0.##}";

        return $"Auction starting at: R{item.StartingPrice:0.##}";
    }
}
