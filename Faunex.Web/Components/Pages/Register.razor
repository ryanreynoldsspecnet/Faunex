@page "/register"
@inject Faunex.Web.Api.FaunexApiClient Api
@inject Faunex.Web.Auth.TokenStore TokenStore
@inject Faunex.Web.Auth.JwtAuthStateProvider AuthStateProvider
@inject NavigationManager Nav

<h3>Register (dev-friendly)</h3>

<div>
    <label>Email</label>
    <input @bind="_email" />
</div>
<div>
    <label>Password</label>
    <input type="password" @bind="_password" />
</div>
<div>
    <label>TenantId (blank for platform)</label>
    <input style="width: 28rem;" @bind="_tenantIdRaw" />
</div>
<div>
    <label>Is Platform Admin</label>
    <input type="checkbox" @bind="_isPlatformAdmin" />
</div>
<div>
    <label>Roles (comma-separated)</label>
    <input style="width: 28rem;" @bind="_rolesRaw" />
</div>

<button @onclick="RegisterAsync">Register</button>

@if (_error is not null)
{
    <p>@_error</p>
}

@code {
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _tenantIdRaw = string.Empty;
    private bool _isPlatformAdmin;
    private string _rolesRaw = "Buyer";

    private string? _error;

    private sealed class RegisterRequest
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public Guid? TenantId { get; set; }
        public bool IsPlatformAdmin { get; set; }
        public List<string> Roles { get; set; } = [];
    }

    private sealed class AuthResponse
    {
        public string AccessToken { get; set; } = string.Empty;
    }

    private async Task RegisterAsync()
    {
        _error = null;

        try
        {
            Guid? tenantId = null;
            if (!string.IsNullOrWhiteSpace(_tenantIdRaw))
            {
                if (!Guid.TryParse(_tenantIdRaw, out var parsed))
                {
                    _error = "Invalid tenant id.";
                    return;
                }

                tenantId = parsed;
            }

            var roles = _rolesRaw
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();

            var response = await Api.PostAsync<RegisterRequest, AuthResponse>("/api/auth/register", new RegisterRequest
            {
                Email = _email,
                Password = _password,
                TenantId = tenantId,
                IsPlatformAdmin = _isPlatformAdmin,
                Roles = roles
            });

            if (response is null || string.IsNullOrWhiteSpace(response.AccessToken))
            {
                _error = "Registration failed.";
                return;
            }

            await TokenStore.SetTokenAsync(response.AccessToken);
            AuthStateProvider.NotifyUserAuthenticationStateChanged();
            Nav.NavigateTo("/browse");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
}
