@page "/auctions/{ListingId:guid}"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject Faunex.Web.Api.FaunexApiClient Api

<h3>Auction details</h3>

@if (_isLoading)
{
    <p>Loading...</p>
}
else if (_error is not null)
{
    <div class="alert alert-danger" role="alert">@_error</div>
}
else if (_item is null)
{
    <div class="alert alert-warning" role="alert">Listing not found.</div>
}
else
{
    <div class="mb-3">
        <h4>@_item.Title</h4>

        @if (_auctionId is null)
        {
            <span class="badge badge-secondary d-inline-block mt-1">No auction for this listing</span>
        }
        else if (_auction?.IsClosed == true)
        {
            <span class="badge badge-danger d-inline-block mt-1">Auction closed</span>
        }
        else
        {
            <span class="badge badge-success d-inline-block mt-1">Open for bidding</span>
        }

        <div>
            <strong>Price</strong>
            <div>@FormatPrice(_item)</div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_item.Description))
        {
            <div class="mt-3">
                <strong>Description</strong>
                <p>@_item.Description</p>
            </div>
        }
    </div>

    <div class="mb-3">
        <h5>Current bid</h5>
        @if (_auctionId is null)
        {
            <p>No auction found for this listing.</p>
        }
        else if (_isAuctionLoading)
        {
            <p>Loading auction...</p>
        }
        else if (_auctionError is not null)
        {
            <div class="alert alert-danger" role="alert">@_auctionError</div>
        }
        else if (_currentPrice is null)
        {
            <p>-</p>
        }
        else
        {
            <p>@FormatMoney(_currentPrice.Value, _item.CurrencyCode)</p>
        }

        <h5>Bid history</h5>
        @if (_auctionId is null)
        {
            <p>-</p>
        }
        else if (_isAuctionLoading)
        {
            <p>Loading bid history...</p>
        }
        else if (_bidsPage is null || _bidsPage.Items is null || _bidsPage.Items.Count == 0)
        {
            <p>No bids yet.</p>
        }
        else
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bid in _bidsPage.Items)
                    {
                        <tr>
                            <td>@FormatMoney(bid.Amount, _item.CurrencyCode)</td>
                        </tr>
                    }
                </tbody>
            </table>

            <div>
                <button class="btn btn-secondary" @onclick="PrevPageAsync" disabled="@(!_canPrev || _isPaging)">Previous</button>
                <button class="btn btn-secondary" @onclick="NextPageAsync" disabled="@(!_canNext || _isPaging)">Next</button>
            </div>
        }
    </div>

    <AuthorizeView>
        <NotAuthorized>
            <div class="alert alert-info">
                Login to place a bid
            </div>
        </NotAuthorized>
        <Authorized>
            @if (_isBuyer)
            {
                @if (_auction is null)
                {
                    <div class="text-muted">This listing does not have an active auction.</div>
                }
                else
                {
                    <div class="mb-3" style="max-width: 320px;">
                        <label class="form-label">Bid amount</label>
                        <input class="form-control" type="number" step="0.01" min="0" @bind="_bidAmount" disabled="@(_isSubmitting || _auction.IsClosed)" />

                        @if (_auction.IsClosed)
                        {
                            <button class="btn btn-secondary mt-2" disabled>
                                Auction closed
                            </button>
                            <div class="text-muted"><small>Bidding is no longer available for this auction.</small></div>
                        }
                        else
                        {
                            <button class="btn btn-primary mt-2" @onclick="PlaceBidAsync" disabled="@(_isSubmitting || _bidAmount <= 0 || _auctionId is null)">
                                @(_isSubmitting ? "Placing bid..." : "Place Bid")
                            </button>
                        }

                        @if (_bidSuccess is not null)
                        {
                            <div class="alert alert-success mt-2">@_bidSuccess</div>
                        }

                        @if (_bidError is not null)
                        {
                            <div class="alert alert-danger mt-2">@_bidError</div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="alert alert-secondary">
                    Only buyers can place bids
                </div>
            }
        </Authorized>
    </AuthorizeView>
}

@code {
    [Parameter] public Guid ListingId { get; set; }

    private bool _isLoading;
    private string? _error;
    private Faunex.Application.DTOs.ListingDto? _item;

    private bool _isAuctionLoading;
    private string? _auctionError;
    private Guid? _auctionId;
    private Faunex.Application.DTOs.AuctionDto? _auction;
    private decimal? _currentPrice;

    private int _skip;
    private const int _take = 20;
    private bool _isPaging;

    private Faunex.Application.DTOs.PagedResult<Faunex.Application.DTOs.BidDto>? _bidsPage;

    private bool _isBuyer;

    private decimal _bidAmount;
    private bool _isSubmitting;
    private string? _bidSuccess;
    private string? _bidError;

    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _error = null;
        _item = null;

        _isAuctionLoading = false;
        _auctionError = null;
        _auctionId = null;
        _auction = null;
        _currentPrice = null;
        _bidsPage = null;
        _skip = 0;
        _isPaging = false;

        _isBuyer = false;

        _bidAmount = 0;
        _isSubmitting = false;
        _bidSuccess = null;
        _bidError = null;

        try
        {
            _item = await Api.GetAsync<Faunex.Application.DTOs.ListingDto>($"/api/listings/{ListingId}");

            var authState = AuthenticationStateTask is null ? null : await AuthenticationStateTask;
            var user = authState?.User;

            _isBuyer = user?.Identity?.IsAuthenticated == true
                && (user.IsInRole("Buyer") || user.Claims.Any(c => c.Type == "role" && c.Value == "Buyer"));

            if (_item is not null)
            {
                await LoadAuctionAsync(resetPaging: true);
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadAuctionAsync(bool resetPaging)
    {
        if (_item is null)
        {
            return;
        }

        _isAuctionLoading = true;
        _auctionError = null;

        if (resetPaging)
        {
            _skip = 0;
        }

        try
        {
            var auctions = await Api.GetAsync<IReadOnlyList<Faunex.Application.DTOs.AuctionDto>>($"/api/auctions/by-listing/{_item.Id}");
            _auction = auctions?.FirstOrDefault();
            _auctionId = _auction?.Id;

            if (_auctionId is null)
            {
                _currentPrice = null;
                _bidsPage = null;
                return;
            }

            _currentPrice = await LoadCurrentPriceAsync(_auctionId.Value);
            _bidsPage = await LoadBidsPageAsync(_auctionId.Value, _skip, _take);
        }
        catch (Exception ex)
        {
            _auctionError = ex.Message;
        }
        finally
        {
            _isAuctionLoading = false;
        }
    }

    private sealed class CurrentPriceDto
    {
        public decimal Price { get; set; }
    }

    private static bool HasNext(Faunex.Application.DTOs.PagedResult<Faunex.Application.DTOs.BidDto> page, int skip, int take)
    {
        return skip + take < page.Total;
    }

    private bool _canPrev => _skip > 0;

    private bool _canNext
    {
        get
        {
            if (_bidsPage is null)
            {
                return false;
            }

            return HasNext(_bidsPage, _skip, _take);
        }
    }

    private async Task<decimal?> LoadCurrentPriceAsync(Guid auctionId)
    {
        var dto = await Api.GetAsync<CurrentPriceDto>($"/api/auctions/{auctionId}/price");
        return dto is null ? null : dto.Price;
    }

    private Task<Faunex.Application.DTOs.PagedResult<Faunex.Application.DTOs.BidDto>?> LoadBidsPageAsync(Guid auctionId, int skip, int take)
        => Api.GetAsync<Faunex.Application.DTOs.PagedResult<Faunex.Application.DTOs.BidDto>>($"/api/auctions/{auctionId}/bids?skip={skip}&take={take}");

    private async Task PrevPageAsync()
    {
        if (_auctionId is null || _isPaging || !_canPrev)
        {
            return;
        }

        _isPaging = true;
        try
        {
            _skip = Math.Max(0, _skip - _take);
            _bidsPage = await LoadBidsPageAsync(_auctionId.Value, _skip, _take);
        }
        catch (Exception ex)
        {
            _auctionError = ex.Message;
        }
        finally
        {
            _isPaging = false;
        }
    }

    private async Task NextPageAsync()
    {
        if (_auctionId is null || _isPaging || !_canNext)
        {
            return;
        }

        _isPaging = true;
        try
        {
            _skip += _take;
            _bidsPage = await LoadBidsPageAsync(_auctionId.Value, _skip, _take);
        }
        catch (Exception ex)
        {
            _auctionError = ex.Message;
        }
        finally
        {
            _isPaging = false;
        }
    }

    private async Task RefreshAfterBidAsync()
    {
        if (_auctionId is null)
        {
            return;
        }

        try
        {
            _currentPrice = await LoadCurrentPriceAsync(_auctionId.Value);
            _skip = 0;
            _bidsPage = await LoadBidsPageAsync(_auctionId.Value, _skip, _take);
        }
        catch (Exception ex)
        {
            _auctionError = ex.Message;
        }
    }

    private async Task PlaceBidAsync()
    {
        if (_item is null)
        {
            return;
        }

        _bidSuccess = null;
        _bidError = null;

        if (_bidAmount <= 0)
        {
            _bidError = "Bid amount must be greater than zero.";
            return;
        }

        _isSubmitting = true;

        try
        {
            await Api.PostAsync("/api/buyer/bids", new Faunex.Application.DTOs.CreateBidRequest(_item.Id, _bidAmount));
            _bidSuccess = "Bid placed successfully";

            await RefreshAfterBidAsync();
        }
        catch (Exception ex)
        {
            _bidError = ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private static string FormatPrice(Faunex.Application.DTOs.ListingDto item)
    {
        var price = item.BuyNowPrice ?? item.StartingPrice;
        return FormatMoney(price, item.CurrencyCode);
    }

    private static string FormatMoney(decimal amount, string currencyCode)
        => $"{amount:0.##} {currencyCode}";
}
