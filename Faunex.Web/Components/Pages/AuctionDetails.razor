@page "/auctions/{ListingId:guid}"

@using Microsoft.AspNetCore.Components.Authorization

@inject Faunex.Web.Api.FaunexApiClient Api

<h3>Auction</h3>

@if (_isLoading)
{
    <p>Loading...</p>
}
else if (_error is not null)
{
    <p>@_error</p>
}
else if (_item is null)
{
    <p>Auction not found</p>
}
else
{
    <div class="mb-3">
        <h4>@_item.Title</h4>
        <p class="text-muted mb-1"><strong>Auction status:</strong> Approved</p>
        <p class="text-muted mb-1"><strong>Listing type:</strong> Auction</p>
        <p class="mb-1"><strong>Starting price:</strong> @($"R{_item.StartingPrice:0.##}")</p>

        @if (!string.IsNullOrWhiteSpace(_item.Description))
        {
            <div class="mt-3">
                <strong>Description</strong>
                <p>@_item.Description</p>
            </div>
        }
    </div>

    <div class="mb-3">
        <h5>Current bid</h5>
        <p>Coming soon</p>

        <h5>Bid history</h5>
        <p>Coming soon</p>
    </div>

    <AuthorizeView>
        <NotAuthorized>
            <div class="alert alert-info">
                Login to place a bid
            </div>
        </NotAuthorized>
        <Authorized>
            @if (_isBuyer)
            {
                <div class="mb-3" style="max-width: 320px;">
                    <label class="form-label">Bid amount</label>
                    <input class="form-control" type="number" step="0.01" min="0" @bind="_bidAmount" disabled="@_isSubmitting" />

                    <button class="btn btn-primary mt-2" @onclick="PlaceBidAsync" disabled="@(_isSubmitting || _bidAmount <= 0)">
                        @(_isSubmitting ? "Placing bid..." : "Place Bid")
                    </button>

                    @if (_bidSuccess is not null)
                    {
                        <div class="alert alert-success mt-2">@_bidSuccess</div>
                    }

                    @if (_bidError is not null)
                    {
                        <div class="alert alert-danger mt-2">@_bidError</div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-secondary">
                    Only buyers can place bids
                </div>
            }
        </Authorized>
    </AuthorizeView>
}

@code {
    [Parameter] public Guid ListingId { get; set; }

    private bool _isLoading;
    private string? _error;
    private Faunex.Application.DTOs.ListingDto? _item;

    private bool _isBuyer;

    private decimal _bidAmount;
    private bool _isSubmitting;
    private string? _bidSuccess;
    private string? _bidError;

    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _error = null;
        _item = null;
        _isBuyer = false;

        _bidAmount = 0;
        _isSubmitting = false;
        _bidSuccess = null;
        _bidError = null;

        try
        {
            var items = await Api.GetAsync<IReadOnlyList<Faunex.Application.DTOs.ListingDto>>("/api/browse/listings");
            _item = items?.FirstOrDefault(x => x.Id == ListingId);

            var authState = AuthenticationStateTask is null ? null : await AuthenticationStateTask;
            var user = authState?.User;

            _isBuyer = user?.Identity?.IsAuthenticated == true
                && (user.IsInRole("Buyer") || user.Claims.Any(c => c.Type == "role" && c.Value == "Buyer"));
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task PlaceBidAsync()
    {
        if (_item is null)
        {
            return;
        }

        _bidSuccess = null;
        _bidError = null;

        if (_bidAmount <= 0)
        {
            _bidError = "Bid amount must be greater than zero.";
            return;
        }

        _isSubmitting = true;

        try
        {
            await Api.PostAsync("/api/buyer/bids", new Faunex.Application.DTOs.CreateBidRequest(_item.Id, _bidAmount));
            _bidSuccess = "Bid placed successfully";
        }
        catch (Exception ex)
        {
            _bidError = ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
